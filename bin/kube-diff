#!/usr/bin/env bash

# shellcheck disable=2164
path_to_script="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
path_to_repo_root="$( cd -- "$(dirname "$path_to_script")" >/dev/null 2>&1 ; pwd -P )"

source "$path_to_repo_root/core.sh"

prevent_colorized_and_multiline_output="command cat -"

if [ -z "$KUBE_DIFF_RENDERER" ]; then
  if [ -t 1 ]; then
    if __command_exists delta; then
      KUBE_DIFF_RENDERER="delta"
    else
      KUBE_DIFF_RENDERER="less"
    fi
  else
    KUBE_DIFF_RENDERER="command cat -"
  fi
fi

usage() {
  echo "Usage: kube-diff [context-a] [context-b] <kubectl command>"
  echo
  echo "Examples:"
  echo "  \$ kube-diff qa prod describe deployment xyz"
  exit 1
}

kube_diff() {
  if [ "$#" -lt 3 ]; then
    usage
  fi

  left="$1"
  right="$2"

  shift
  shift

  if [ -t 1 ]; then
    diff -u <(eval "kubectl \"--context=$left\" $(printf ' %q' "$@") | $prevent_colorized_and_multiline_output") \
            <(eval "kubectl \"--context=$right\" $(printf ' %q' "$@") | $prevent_colorized_and_multiline_output") \
            | eval "$KUBE_DIFF_RENDERER"
  else
    diff -u <(eval "kubectl \"--context=$left\" $(printf ' %q' "$@") | $prevent_colorized_and_multiline_output") \
            <(eval "kubectl \"--context=$right\" $(printf ' %q' "$@") | $prevent_colorized_and_multiline_output")
  fi
}

if [ "$#" -eq 0 ]; then
  usage
else
  kube_diff "$@"
fi
